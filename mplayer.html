<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced Music Player</title>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #121212;
    color: #eee;
    display: flex; flex-direction: column; height: 100vh;
    transition: background 0.3s, color 0.3s;
  }
  header {
    padding: 1rem;
    background: #1f1f1f;
    display: flex; justify-content: space-between; align-items: center;
    flex-wrap: wrap;
  }
  header > div {
    display: flex;
    gap: 0.75rem;
    align-items: center;
  }
  #drop-area {
    border: 2px dashed #444;
    border-radius: 8px;
    padding: 2rem;
    text-align: center;
    cursor: pointer;
    margin: 1rem;
    flex-grow: 1;
    min-height: 100px;
  }
  #drop-area.dragover {
    border-color: #1db954;
    background: #282828;
  }
  #playlist {
    list-style: none;
    margin: 1rem;
    padding: 0;
    max-height: 220px;
    overflow-y: auto;
    flex-grow: 1;
    background: #181818;
    border-radius: 8px;
  }
  #playlist li {
    padding: 0.5rem;
    border-bottom: 1px solid #333;
    display: flex; align-items: center;
    cursor: pointer;
  }
  #playlist li.active {
    background: #1db954;
    color: #000;
  }
  #playlist li:hover {
    background: #333;
  }
  #playlist li .meta {
    margin-left: 1rem;
    flex-grow: 1;
  }
  #playlist li .title {
    font-weight: bold;
  }
  #playlist li .artist {
    font-size: 0.9rem;
    color: #bbb;
  }
  #controls {
    display: flex;
    justify-content: center;
    margin: 1rem;
    gap: 1rem;
  }
  button {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 4px;
    background: #1db954;
    color: #121212;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    transition: background 0.3s;
  }
  button.active {
    background: #14833b;
  }
  #search {
    width: 100%;
    max-width: 300px;
    padding: 0.5rem;
    border-radius: 4px;
    border: none;
    margin: 0 1rem;
    background: #222;
    color: #eee;
  }
  #stream-input {
    width: 70%;
    max-width: 400px;
    padding: 0.5rem;
    border-radius: 4px;
    border: none;
    background: #222;
    color: #eee;
  }
  #stream-controls {
    display: flex;
    gap: 0.5rem;
    margin: 1rem;
    justify-content: center;
  }
  #audio-player {
    width: 100%;
    outline: none;
  }
  #youtube-player {
    width: 100%;
    max-width: 560px;
    height: 315px;
    margin: 1rem auto;
    display: none;
  }
  #yt-video-title {
    text-align: center;
    font-weight: bold;
    margin-top: 0.5rem;
  }
  canvas {
    display: block;
    margin: 1rem auto;
    background: #000;
    border-radius: 8px;
  }
  #lang-select {
    background: #222;
    color: #eee;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
  }
  #volume-control-container {
    text-align: center;
    margin: 0.5rem 0 1rem;
  }
  #volume-slider {
    vertical-align: middle;
    width: 200px;
  }

  /* Light theme */
  body.light-theme {
    background: #f3f3f3;
    color: #111;
  }
  body.light-theme header {
    background: #ddd;
  }
  body.light-theme #drop-area {
    border-color: #aaa;
    background: #fff;
    color: #111;
  }
  body.light-theme #playlist {
    background: #eaeaea;
  }
  body.light-theme #playlist li:hover {
    background: #ccc;
  }
  body.light-theme #playlist li.active {
    background: #1db954;
    color: #000;
  }
  body.light-theme button {
    background: #1db954;
    color: #000;
  }
  body.light-theme #search,
  body.light-theme #stream-input,
  body.light-theme #lang-select {
    background: #fff;
    color: #000;
  }
</style>
</head>
<body>

<header>
  <div>
    <button id="play-pause-btn">Play</button>
    <button id="prev-btn">Prev</button>
    <button id="next-btn">Next</button>
    <button id="shuffle-btn">Shuffle Off</button>
    <button id="repeat-btn">Repeat Off</button>
  </div>
  <div style="display: flex; gap: 1rem; align-items: center;">
    <input id="search" type="search" placeholder="Search songs..." aria-label="Search songs" />
    <select id="lang-select" aria-label="Select language">
      <option value="en" selected>English</option>
      <option value="es">EspaÃ±ol</option>
    </select>
    <button id="theme-toggle" aria-label="Toggle theme">ðŸŒ™</button>
  </div>
</header>

<div id="drop-area" tabindex="0">Drag & Drop audio files here or click to select</div>
<input type="file" id="file-input" multiple accept="audio/*" style="display:none" />

<ul id="playlist" aria-label="Playlist"></ul>

<div id="stream-controls">
  <input type="url" id="stream-input" placeholder="Enter YouTube or SoundCloud URL" aria-label="Stream URL" />
  <button id="stream-play-btn">Play Stream</button>
  <button id="stream-stop-btn">Stop Stream</button>
</div>

<audio id="audio-player" controls></audio>

<div id="youtube-player">
  <iframe id="yt-iframe" width="560" height="315" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>
  <div id="yt-video-title"></div>
</div>

<canvas id="audio-visualizer" width="600" height="100"></canvas>

<div id="volume-control-container">
  <label for="volume-slider" style="margin-right: 0.5rem;">ðŸ”Š Volume</label>
  <input id="volume-slider" type="range" min="0" max="1" step="0.01" value="1" aria-label="Volume Control" />
</div>

<div style="text-align:center; margin: 1rem;">
  <button id="export-playlist-btn">Export Playlist</button>
  <button id="import-playlist-btn">Import Playlist</button>
  <input type="file" id="import-file-input" accept=".json" style="display:none" />
</div>

<script>
// Localization
const locales = {
  en: {
    dragDrop: "Drag & Drop audio files here or click to select",
    searchPlaceholder: "Search songs...",
    streamPlaceholder: "Enter YouTube or SoundCloud URL",
    playStream: "Play Stream",
    stopStream: "Stop Stream",
    play: "Play",
    pause: "Pause",
    prev: "Prev",
    next: "Next",
    shuffleOff: "Shuffle Off",
    shuffleOn: "Shuffle On",
    repeatOff: "Repeat Off",
    repeatOne: "Repeat One",
    repeatAll: "Repeat All",
    exportPlaylist: "Export Playlist",
    importPlaylist: "Import Playlist",
    unsupportedStream: "Unsupported stream URL or format.",
    enterStreamUrl: "Please enter a URL to stream.",
    noTracks: "No tracks in playlist.",
  },
  es: {
    dragDrop: "Arrastra y suelta archivos de audio aquÃ­ o haz clic para seleccionar",
    searchPlaceholder: "Buscar canciones...",
    streamPlaceholder: "Introduce URL de YouTube o SoundCloud",
    playStream: "Reproducir",
    stopStream: "Detener",
    play: "Reproducir",
    pause: "Pausa",
    prev: "Anterior",
    next: "Siguiente",
    shuffleOff: "Aleatorio Off",
    shuffleOn: "Aleatorio On",
    repeatOff: "Repetir Off",
    repeatOne: "Repetir 1",
    repeatAll: "Repetir Todo",
    exportPlaylist: "Exportar Lista",
    importPlaylist: "Importar Lista",
    unsupportedStream: "URL o formato no soportado.",
    enterStreamUrl: "Por favor introduce una URL para reproducir.",
    noTracks: "No hay canciones en la lista.",
  }
};

let currentLang = localStorage.getItem('amp-lang') || 'en';

function t(key) {
  return locales[currentLang][key] || key;
}

// UI elements
const elements = {
  dropArea: document.getElementById('drop-area'),
  fileInput: document.getElementById('file-input'),
  playlist: document.getElementById('playlist'),
  audioPlayer: document.getElementById('audio-player'),
  playPauseBtn: document.getElementById('play-pause-btn'),
  prevBtn: document.getElementById('prev-btn'),
  nextBtn: document.getElementById('next-btn'),
  shuffleBtn: document.getElementById('shuffle-btn'),
  repeatBtn: document.getElementById('repeat-btn'),
  searchInput: document.getElementById('search'),
  streamInput: document.getElementById('stream-input'),
  streamPlayBtn: document.getElementById('stream-play-btn'),
  streamStopBtn: document.getElementById('stream-stop-btn'),
  youtubePlayer: document.getElementById('youtube-player'),
  ytIframe: document.getElementById('yt-iframe'),
  ytVideoTitle: document.getElementById('yt-video-title'),
  audioVisualizer: document.getElementById('audio-visualizer'),
  volumeSlider: document.getElementById('volume-slider'),
  langSelect: document.getElementById('lang-select'),
  themeToggle: document.getElementById('theme-toggle'),
  exportPlaylistBtn: document.getElementById('export-playlist-btn'),
  importPlaylistBtn: document.getElementById('import-playlist-btn'),
  importFileInput: document.getElementById('import-file-input'),
};

elements.langSelect.value = currentLang;

// State
let playlist = [];
let currentTrackIndex = -1;
let isPlaying = false;
let isShuffle = false;
let repeatMode = 0; // 0=off,1=one,2=all
let audioContext, analyser, sourceNode, animationId;

// Helpers
function updateTextContent() {
  elements.dropArea.textContent = t('dragDrop');
  elements.searchInput.placeholder = t('searchPlaceholder');
  elements.streamInput.placeholder = t('streamPlaceholder');
  elements.streamPlayBtn.textContent = t('playStream');
  elements.streamStopBtn.textContent = t('stopStream');
  elements.playPauseBtn.textContent = isPlaying ? t('pause') : t('play');
  elements.prevBtn.textContent = t('prev');
  elements.nextBtn.textContent = t('next');
  elements.shuffleBtn.textContent = isShuffle ? t('shuffleOn') : t('shuffleOff');
  const repeatTexts = [t('repeatOff'), t('repeatOne'), t('repeatAll')];
  elements.repeatBtn.textContent = repeatTexts[repeatMode];
  elements.exportPlaylistBtn.textContent = t('exportPlaylist');
  elements.importPlaylistBtn.textContent = t('importPlaylist');
}

function setActivePlaylistItem(index) {
  const items = elements.playlist.querySelectorAll('li');
  items.forEach((li, i) => {
    li.classList.toggle('active', i === index);
  });
}

// Playlist rendering
function renderPlaylist() {
  const filter = elements.searchInput.value.toLowerCase();
  elements.playlist.innerHTML = '';
  playlist.forEach((track, i) => {
    if (track.title.toLowerCase().includes(filter) || (track.artist && track.artist.toLowerCase().includes(filter))) {
      const li = document.createElement('li');
      li.setAttribute('role', 'option');
      li.tabIndex = 0;
      li.innerHTML = `<div class="meta"><div class="title">${track.title}</div><div class="artist">${track.artist || ''}</div></div>`;
      if (i === currentTrackIndex) li.classList.add('active');
      li.addEventListener('click', () => playTrack(i));
      li.addEventListener('keydown', e => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          playTrack(i);
        }
      });
      elements.playlist.appendChild(li);
    }
  });
}

// Load metadata from file
function loadMetadata(file, callback) {
  // Use FileReader and music-metadata-browser if available, else fallback
  if (window.musicMetadata) {
    const reader = new FileReader();
    reader.onload = function(evt) {
      musicMetadata.parseBlob(new Blob([evt.target.result])).then(metadata => {
        callback(metadata.common.title || file.name, metadata.common.artist || '');
      }).catch(() => {
        callback(file.name, '');
      });
    };
    reader.readAsArrayBuffer(file);
  } else {
    callback(file.name, '');
  }
}

// Add files
function addFiles(files) {
  Array.from(files).forEach(file => {
    if (!file.type.startsWith('audio/')) return;
    loadMetadata(file, (title, artist) => {
      const url = URL.createObjectURL(file);
      playlist.push({ title, artist, url, file });
      if (currentTrackIndex === -1) {
        playTrack(0);
      }
      renderPlaylist();
    });
  });
}

// Play track by index
function playTrack(index) {
  if (index < 0 || index >= playlist.length) return;
  currentTrackIndex = index;
  const track = playlist[index];
  stopStream(); // Stop any streaming video
  elements.audioPlayer.src = track.url;
  elements.audioPlayer.play();
  isPlaying = true;
  updateTextContent();
  setActivePlaylistItem(index);
  setupVisualizer();
}

// Playback controls
function playPause() {
  if (elements.audioPlayer.paused) {
    elements.audioPlayer.play();
  } else {
    elements.audioPlayer.pause();
  }
}
function playNext() {
  if (playlist.length === 0) return;
  if (isShuffle) {
    playTrack(Math.floor(Math.random() * playlist.length));
  } else {
    if (repeatMode === 2) {
      playTrack((currentTrackIndex + 1) % playlist.length);
    } else {
      if (currentTrackIndex < playlist.length - 1) {
        playTrack(currentTrackIndex + 1);
      } else if (repeatMode === 2) {
        playTrack(0);
      }
    }
  }
}
function playPrev() {
  if (playlist.length === 0) return;
  if (isShuffle) {
    playTrack(Math.floor(Math.random() * playlist.length));
  } else {
    if (currentTrackIndex > 0) {
      playTrack(currentTrackIndex - 1);
    } else if (repeatMode === 2) {
      playTrack(playlist.length - 1);
    }
  }
}

// Shuffle and Repeat toggle
elements.shuffleBtn.addEventListener('click', () => {
  isShuffle = !isShuffle;
  updateTextContent();
});
elements.repeatBtn.addEventListener('click', () => {
  repeatMode = (repeatMode + 1) % 3;
  updateTextContent();
});

// Volume control
elements.volumeSlider.addEventListener('input', e => {
  elements.audioPlayer.volume = e.target.value;
});
elements.audioPlayer.volume = elements.volumeSlider.value;

// Keyboard shortcuts
document.addEventListener('keydown', e => {
  if (['INPUT', 'TEXTAREA', 'SELECT'].includes(document.activeElement.tagName)) return;
  switch (e.key.toLowerCase()) {
    case ' ':
      e.preventDefault();
      playPause();
      break;
    case 'arrowright':
      playNext();
      break;
    case 'arrowleft':
      playPrev();
      break;
    case 's':
      elements.shuffleBtn.click();
      break;
    case 'r':
      elements.repeatBtn.click();
      break;
  }
});

// Search filter
elements.searchInput.addEventListener('input', renderPlaylist);

// Drag & Drop
elements.dropArea.addEventListener('click', () => elements.fileInput.click());
elements.dropArea.addEventListener('dragover', e => {
  e.preventDefault();
  elements.dropArea.classList.add('dragover');
});
elements.dropArea.addEventListener('dragleave', e => {
  e.preventDefault();
  elements.dropArea.classList.remove('dragover');
});
elements.dropArea.addEventListener('drop', e => {
  e.preventDefault();
  elements.dropArea.classList.remove('dragover');
  addFiles(e.dataTransfer.files);
});
elements.fileInput.addEventListener('change', e => {
  addFiles(e.target.files);
});

// Stream playback (basic placeholder, only allows direct audio URLs for simplicity)
elements.streamPlayBtn.addEventListener('click', () => {
  const url = elements.streamInput.value.trim();
  if (!url) {
    alert(t('enterStreamUrl'));
    return;
  }
  // Basic detection for YouTube and SoundCloud could be added here
  // For now, just set audio src if it is audio file url
  if (url.match(/\.(mp3|ogg|wav|m4a)(\?.*)?$/i)) {
    stopStream();
    elements.audioPlayer.src = url;
    elements.audioPlayer.play();
    elements.youtubePlayer.style.display = 'none';
    isPlaying = true;
    updateTextContent();
  } else {
    alert(t('unsupportedStream'));
  }
});
elements.streamStopBtn.addEventListener('click', stopStream);

function stopStream() {
  elements.audioPlayer.pause();
  elements.audioPlayer.src = '';
  elements.youtubePlayer.style.display = 'none';
  elements.ytIframe.src = '';
  elements.ytVideoTitle.textContent = '';
  isPlaying = false;
  updateTextContent();
}

// Play/pause button
elements.playPauseBtn.addEventListener('click', playPause);
elements.prevBtn.addEventListener('click', playPrev);
elements.nextBtn.addEventListener('click', playNext);

elements.audioPlayer.addEventListener('play', () => {
  isPlaying = true;
  updateTextContent();
});
elements.audioPlayer.addEventListener('pause', () => {
  isPlaying = false;
  updateTextContent();
});
elements.audioPlayer.addEventListener('ended', () => {
  if (repeatMode === 1) {
    playTrack(currentTrackIndex);
  } else {
    playNext();
  }
});

// Playlist export/import
elements.exportPlaylistBtn.addEventListener('click', () => {
  if (playlist.length === 0) {
    alert(t('noTracks'));
    return;
  }
  const dataStr = JSON.stringify(playlist.map(t => ({title: t.title, artist: t.artist})));
  const blob = new Blob([dataStr], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'playlist.json';
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
});
elements.importPlaylistBtn.addEventListener('click', () => elements.importFileInput.click());
elements.importFileInput.addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = evt => {
    try {
      const imported = JSON.parse(evt.target.result);
      if (!Array.isArray(imported)) throw new Error('Invalid format');
      playlist = imported.map(item => ({
        title: item.title || 'Unknown',
        artist: item.artist || '',
        url: '', // no local file attached
      }));
      currentTrackIndex = -1;
      renderPlaylist();
    } catch {
      alert('Invalid playlist file.');
    }
  };
  reader.readAsText(file);
});

// Localization change
elements.langSelect.addEventListener('change', e => {
  currentLang = e.target.value;
  localStorage.setItem('amp-lang', currentLang);
  updateTextContent();
  renderPlaylist();
});

// Theme toggle
function applyTheme(theme) {
  document.body.classList.toggle('light-theme', theme === 'light');
  localStorage.setItem('amp-theme', theme);
  elements.themeToggle.textContent = theme === 'light' ? 'ðŸŒž' : 'ðŸŒ™';
}
elements.themeToggle.addEventListener('click', () => {
  const current = localStorage.getItem('amp-theme') || 'dark';
  applyTheme(current === 'dark' ? 'light' : 'dark');
});
applyTheme(localStorage.getItem('amp-theme') || 'dark');

// Audio Visualizer
function setupVisualizer() {
  if (animationId) cancelAnimationFrame(animationId);
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  if (sourceNode) {
    sourceNode.disconnect();
  }
  sourceNode = audioContext.createMediaElementSource(elements.audioPlayer);
  analyser = audioContext.createAnalyser();
  sourceNode.connect(analyser);
  analyser.connect(audioContext.destination);
  analyser.fftSize = 256;
  const bufferLength = analyser.frequencyBinCount;
  const dataArray = new Uint8Array(bufferLength);
  const canvas = elements.audioVisualizer;
  const ctx = canvas.getContext('2d');

  function draw() {
    animationId = requestAnimationFrame(draw);
    analyser.getByteFrequencyData(dataArray);
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    const barWidth = (canvas.width / bufferLength) * 1.5;
    let x = 0;
    for(let i = 0; i < bufferLength; i++) {
      const barHeight = dataArray[i];
      ctx.fillStyle = `rgb(${barHeight + 100},50,50)`;
      ctx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight / 2);
      x += barWidth + 1;
    }
  }
  draw();
}

// Initial UI Setup
updateTextContent();
renderPlaylist();

</script>
</body>
</html>
