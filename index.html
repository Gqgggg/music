<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Advanced Music Player</title>

<link rel="manifest" href="/manifest.json">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Music Player">
<link rel="apple-touch-icon" href="/icons/icon-192x192.png"> <style>
  /* Reset */
  * {
    box-sizing: border-box;
  }

  :root {
    --primary-color: #ff6f61; /* Define a CSS variable for the primary color */
  }

  body {
    margin: 0;
    background-color: #121212;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex;
    justify-content: center;
    padding: 20px;
    min-height: 100vh;
  }

  #player-container {
    background: #1e1e1e;
    width: 360px;
    border-radius: 16px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    user-select: none;
  }

  .controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 14px;
    padding: 15px 20px;
    background: #272727;
    border-bottom: 1px solid #333;
  }

  .controls button {
    background: #333;
    border: none;
    border-radius: 50%;
    width: 42px;
    height: 42px;
    color: #eee;
    font-size: 18px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .controls button:hover,
  .controls button:focus {
    background-color: var(--primary-color); /* Use CSS variable */
    outline: none;
  }

  #play-pause-btn {
    width: 54px;
    height: 54px;
    font-size: 22px;
    background: var(--primary-color); /* Use CSS variable */
    box-shadow: 0 0 10px var(--primary-color)aa; /* Use CSS variable */
  }

  #play-pause-btn:hover,
  #play-pause-btn:focus {
    background: #ff4b3f; /* Keep a slightly different hover for the main button or make it a derived variable */
    box-shadow: 0 0 14px #ff4b3fcc;
  }

  #cover-art {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: cover;
    border-radius: 0 0 16px 16px;
    box-shadow: inset 0 0 40px #0008;
    margin-bottom: 8px;
    background: #2a2a2a;
  }

  #playlist {
    max-height: 280px;
    overflow-y: auto;
    background: #121212;
    padding: 8px 0;
    scrollbar-width: thin;
    scrollbar-color: var(--primary-color) #2a2a2a; /* Use CSS variable */
  }

  #playlist::-webkit-scrollbar {
    width: 8px;
  }

  #playlist::-webkit-scrollbar-thumb {
    background-color: var(--primary-color); /* Use CSS variable */
    border-radius: 4px;
  }

  .playlist-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 20px;
    cursor: pointer;
    transition: background-color 0.25s ease;
    border-left: 4px solid transparent;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    user-select:none;
  }

  .playlist-item:hover {
    background-color: #272727;
  }

  .playlist-item.active {
    background-color: var(--primary-color); /* Use CSS variable */
    border-left-color: #ff4433; /* Keep a slightly different border color or make it a derived variable */
    color: #fff;
  }

  .playlist-item img {
    width: 36px;
    height: 36px;
    object-fit: cover;
    border-radius: 6px;
    box-shadow: 0 0 6px #0005;
    flex-shrink: 0;
  }

  .title-artist {
    display: flex;
    flex-direction: column;
    font-size: 14px;
    overflow: hidden;
  }

  .title-artist .title {
    font-weight: 600;
    color: #fff;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .title-artist .artist {
    font-weight: 400;
    color: #ccc;
    font-size: 12px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  #search-input,
  #stream-url-input {
    width: calc(100% - 40px);
    margin: 12px 20px;
    padding: 8px 12px;
    border-radius: 8px;
    border: none;
    font-size: 14px;
    background-color: #272727;
    color: #eee;
    outline: none;
    transition: background-color 0.3s ease;
  }

  #search-input::placeholder,
  #stream-url-input::placeholder {
    color: #777;
  }

  #search-input:focus,
  #stream-url-input:focus {
    background-color: #3c3c3c;
  }

  #play-stream-btn,
  #export-playlist-btn,
  #import-playlist-btn {
    margin: 0 20px 14px;
    padding: 10px;
    width: calc(100% - 40px);
    border: none;
    border-radius: 10px;
    background-color: var(--primary-color); /* Use CSS variable */
    color: white;
    font-weight: 600;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #play-stream-btn:hover,
  #export-playlist-btn:hover,
  #import-playlist-btn:hover,
  #play-stream-btn:focus,
  #export-playlist-btn:focus,
  #import-playlist-btn:focus {
    background-color: #ff4433; /* Keep a slightly different hover or make it a derived variable */
    outline: none;
  }

  #visualizer {
    width: 100%;
    height: 60px;
    background: #181818;
    border-top: 1px solid #333;
  }

  #lang-select,
  #theme-color-picker { /* Add theme color picker here for consistent styling */
    margin: 10px 20px 20px;
    padding: 6px 10px;
    border-radius: 8px;
    background: #272727;
    border: none;
    color: #eee;
    font-size: 14px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }

  #lang-select:hover,
  #lang-select:focus,
  #theme-color-picker:hover, /* Add theme color picker here */
  #theme-color-picker:focus { /* Add theme color picker here */
    background-color: #3c3c3c;
    outline: none;
  }

  /* Drag & Drop highlight */
  #player-container.dragover {
    border: 3px dashed var(--primary-color); /* Use CSS variable */
  }
</style>
</head>
<body>
<div id="player-container" role="main" aria-label="Music Player" tabindex="0">

  <img id="cover-art" src="" alt="No track playing" />

  <div class="controls" role="region" aria-label="Playback controls">
    <button id="prev-btn" aria-label="Previous track" tabindex="0">‚èÆ</button>
    <button id="play-pause-btn" aria-label="Play/Pause" tabindex="0">‚ñ∂Ô∏è</button>
    <button id="next-btn" aria-label="Next track" tabindex="0">‚è≠</button>
    <button id="shuffle-btn" aria-pressed="false" aria-label="Shuffle toggle" tabindex="0">üîÄ</button>
    <button id="repeat-btn" aria-pressed="false" aria-label="Repeat toggle" tabindex="0">üîÅ</button>
  </div>

  <input id="search-input" type="search" placeholder="Search songs..." aria-label="Search songs" />

  <ul id="playlist" role="list" tabindex="0" aria-label="Playlist"></ul>

  <input id="stream-url-input" type="url" placeholder="Enter streaming URL (mp3/aac)" aria-label="Streaming URL" />
  <button id="play-stream-btn" aria-label="Play stream from URL">Play Stream</button>

  <button id="export-playlist-btn" aria-label="Export playlist">Export Playlist</button>
  <button id="import-playlist-btn" aria-label="Import playlist">Import Playlist</button>
  <input type="file" id="import-file-input" accept=".json" hidden />

  <canvas id="visualizer" aria-hidden="true"></canvas>

  <select id="lang-select" aria-label="Select language">
    <option value="en" selected>English</option>
    <option value="es">Espa√±ol</option>
    <option value="fr">Fran√ßais</option>
    <option value="de">Deutsch</option>
  </select>

  <input type="color" id="theme-color-picker" value="#ff6f61" aria-label="Choose theme color" />

</div>

<script>
(() => {
  // Localization strings
  const locales = {
    en: {
      searchPlaceholder: "Search songs...",
      streamPlaceholder: "Enter streaming URL (mp3/aac)",
      playStream: "Play Stream",
      exportPlaylist: "Export Playlist",
      importPlaylist: "Import Playlist",
      noTrack: "No track playing",
      shuffle: "Shuffle toggle",
      repeat: "Repeat toggle",
      prevTrack: "Previous track",
      nextTrack: "Next track",
      playPause: "Play/Pause",
      playlist: "Playlist",
      selectLang: "Select language",
      fileNotSupported: "File type not supported. Use mp3, wav, ogg, aac.",
      importError: "Failed to import playlist.",
      noSongsInPlaylist: "No songs in playlist.",
      errorLoadingFile: "Error loading file:",
    },
    es: {
      searchPlaceholder: "Buscar canciones...",
      streamPlaceholder: "Introduce URL de streaming (mp3/aac)",
      playStream: "Reproducir Streaming",
      exportPlaylist: "Exportar Lista",
      importPlaylist: "Importar Lista",
      noTrack: "Ninguna canci√≥n reproducida",
      shuffle: "Alternar aleatorio",
      repeat: "Alternar repetici√≥n",
      prevTrack: "Pista anterior",
      nextTrack: "Siguiente pista",
      playPause: "Reproducir/Pausar",
      playlist: "Lista de reproducci√≥n",
      selectLang: "Seleccionar idioma",
      fileNotSupported: "Tipo de archivo no soportado. Usa mp3, wav, ogg, aac.",
      importError: "Error al importar la lista.",
      noSongsInPlaylist: "No hay canciones en la lista.",
      errorLoadingFile: "Error cargando archivo:",
    },
    fr: {
      searchPlaceholder: "Rechercher des chansons...",
      streamPlaceholder: "Entrez l'URL de streaming (mp3/aac)",
      playStream: "Lire le flux",
      exportPlaylist: "Exporter la liste",
      importPlaylist: "Importer la liste",
      noTrack: "Aucune piste en cours",
      shuffle: "Activer le mode al√©atoire",
      repeat: "Activer la r√©p√©tition",
      prevTrack: "Piste pr√©c√©dente",
      nextTrack: "Piste suivante",
      playPause: "Lecture/Pause",
      playlist: "Liste de lecture",
      selectLang: "Choisir la langue",
      fileNotSupported: "Type de fichier non pris en charge. Utilisez mp3, wav, ogg, aac.",
      importError: "√âchec de l'importation de la liste.",
      noSongsInPlaylist: "Aucune chanson dans la liste.",
      errorLoadingFile: "Erreur de chargement du fichier :",
    },
    de: {
      searchPlaceholder: "Songs suchen...",
      streamPlaceholder: "Streaming-URL eingeben (mp3/aac)",
      playStream: "Stream abspielen",
      exportPlaylist: "Playlist exportieren",
      importPlaylist: "Playlist importieren",
      noTrack: "Kein Titel l√§uft",
      shuffle: "Shuffle ein-/ausschalten",
      repeat: "Wiederholung ein-/ausschalten",
      prevTrack: "Vorheriger Titel",
      nextTrack: "N√§chster Titel",
      playPause: "Abspielen/Pause",
      playlist: "Playlist",
      selectLang: "Sprache w√§hlen",
      fileNotSupported: "Dateityp nicht unterst√ºtzt. Verwenden Sie mp3, wav, ogg, aac.",
      importError: "Import der Playlist fehlgeschlagen.",
      noSongsInPlaylist: "Keine Lieder in der Playlist.",
      errorLoadingFile: "Fehler beim Laden der Datei:",
    },
  };

  // Elements
  const container = document.getElementById('player-container');
  const coverArt = document.getElementById('cover-art');
  const playPauseBtn = document.getElementById('play-pause-btn');
  const prevBtn = document.getElementById('prev-btn');
  const nextBtn = document.getElementById('next-btn');
  const shuffleBtn = document.getElementById('shuffle-btn');
  const repeatBtn = document.getElementById('repeat-btn');
  const playlistEl = document.getElementById('playlist');
  const searchInput = document.getElementById('search-input');
  const streamUrlInput = document.getElementById('stream-url-input');
  const playStreamBtn = document.getElementById('play-stream-btn');
  const exportPlaylistBtn = document.getElementById('export-playlist-btn');
  const importPlaylistBtn = document.getElementById('import-playlist-btn');
  const importFileInput = document.getElementById('import-file-input');
  const visualizerCanvas = document.getElementById('visualizer');
  const langSelect = document.getElementById('lang-select');
  const themeColorPicker = document.getElementById('theme-color-picker');

  let locale = locales.en;

  // Audio & state
  const audio = new Audio();
  let playlist = [];
  let filteredPlaylist = [];
  let currentIndex = -1;
  let isPlaying = false;
  let shuffle = false;
  let repeat = false;

  // Audio context for visualization
  let audioCtx, analyser, source, dataArray, animationId;

  // Helper: default cover art SVG as base64 data URI
  const defaultCoverArt = `data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDUwIDUwIiBmaWxsPSIjNjY2NjY2IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgo8Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyMCIgZmlsbD0iI2NjY2NjYyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoNiA2IiBzdHJva2U9IiM0MDQwNDAiIHN0cm9rZS13aWR0aD0iNSIvPgo8cGF0aCBkPSJNMjUgMTVsNiA2LTYgNm0wIDEwbDYgNm0tNi02LTYgNiIgZmlsbD0iIzc3N2Y3ZiIvPgo8L3N2Zz4=`;

  // Set default UI text based on locale
  function updateLocaleTexts() {
    searchInput.placeholder = locale.searchPlaceholder;
    streamUrlInput.placeholder = locale.streamPlaceholder;
    playStreamBtn.textContent = locale.playStream;
    exportPlaylistBtn.textContent = locale.exportPlaylist;
    importPlaylistBtn.textContent = locale.importPlaylist;
    playPauseBtn.setAttribute('aria-label', locale.playPause);
    prevBtn.setAttribute('aria-label', locale.prevTrack);
    nextBtn.setAttribute('aria-label', locale.nextTrack);
    shuffleBtn.setAttribute('aria-label', locale.shuffle);
    repeatBtn.setAttribute('aria-label', locale.repeat);
    playlistEl.setAttribute('aria-label', locale.playlist);
    langSelect.setAttribute('aria-label', locale.selectLang);
    if(currentIndex === -1) coverArt.alt = locale.noTrack;
  }

  updateLocaleTexts();

  // Utilities
  function isSupportedFileType(fileName) {
    return /\.(mp3|wav|ogg|aac)$/i.test(fileName);
  }

  // Extract basic metadata from file or URL (title from filename)
  // For simplicity, no ID3 parsing, just filename for title
  function createTrackObject(fileOrUrl) {
    let title = '', artist = '', url = '', cover = defaultCoverArt;
    if(typeof fileOrUrl === 'string') {
      // Streaming URL
      url = fileOrUrl;
      title = url.split('/').pop().split('?')[0] || 'Streaming Track';
      artist = '';
    } else {
      // File object
      url = URL.createObjectURL(fileOrUrl);
      title = fileOrUrl.name.replace(/\.[^/.]+$/, "");
      artist = '';
    }
    return {title, artist, url, cover};
  }

  // Render playlist items filtered by searchInput.value
  function renderPlaylist() {
    playlistEl.innerHTML = '';

    const searchTerm = searchInput.value.trim().toLowerCase();

    filteredPlaylist = playlist.filter(track => {
      return (
        track.title.toLowerCase().includes(searchTerm) ||
        track.artist.toLowerCase().includes(searchTerm)
      );
    });

    if(filteredPlaylist.length === 0) {
      const emptyMsg = document.createElement('li');
      emptyMsg.textContent = locale.noSongsInPlaylist;
      emptyMsg.style.padding = '10px 20px';
      emptyMsg.style.color = '#777';
      playlistEl.appendChild(emptyMsg);
      return;
    }

    filteredPlaylist.forEach((track, idx) => {
      const item = document.createElement('li');
      item.className = 'playlist-item';
      item.tabIndex = 0;
      item.dataset.idx = playlist.indexOf(track); // store original index

      if(playlist.indexOf(track) === currentIndex) {
        item.classList.add('active');
      }

      const img = document.createElement('img');
      img.src = track.cover || defaultCoverArt;
      img.alt = "";

      const titleArtist = document.createElement('div');
      titleArtist.className = 'title-artist';

      const titleEl = document.createElement('div');
      titleEl.className = 'title';
      titleEl.textContent = track.title;

      const artistEl = document.createElement('div');
      artistEl.className = 'artist';
      artistEl.textContent = track.artist;

      titleArtist.appendChild(titleEl);
      titleArtist.appendChild(artistEl);

      item.appendChild(img);
      item.appendChild(titleArtist);

      // Click or keyboard to select
      item.addEventListener('click', () => {
        playTrack(playlist.indexOf(track));
      });
      item.addEventListener('keydown', (e) => {
        if(e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          playTrack(playlist.indexOf(track));
        }
      });

      playlistEl.appendChild(item);
    });
  }

  // Load & play a track by index
  function playTrack(idx) {
    if(idx < 0 || idx >= playlist.length) return;

    currentIndex = idx;
    const track = playlist[currentIndex];
    audio.src = track.url;
    audio.play().catch(() => {});
    isPlaying = true;
    updatePlayPauseButton();
    updateCoverArt(track.cover);
    updatePlaylistActive();
  }

  // Play next track
  function playNext() {
    if(playlist.length === 0) return;

    if(shuffle) {
      let nextIdx;
      do {
        nextIdx = Math.floor(Math.random() * playlist.length);
      } while (nextIdx === currentIndex && playlist.length > 1);
      playTrack(nextIdx);
    } else {
      if(currentIndex + 1 < playlist.length) {
        playTrack(currentIndex + 1);
      } else if(repeat) {
        playTrack(0);
      } else {
        pauseAudio();
      }
    }
  }

  // Play previous track
  function playPrev() {
    if(playlist.length === 0) return;

    if(shuffle) {
      let prevIdx;
      do {
        prevIdx = Math.floor(Math.random() * playlist.length);
      } while (prevIdx === currentIndex && playlist.length > 1);
      playTrack(prevIdx);
    } else {
      if(currentIndex > 0) {
        playTrack(currentIndex - 1);
      } else if(repeat) {
        playTrack(playlist.length - 1);
      } else {
        pauseAudio();
      }
    }
  }

  // Toggle play/pause
  function togglePlayPause() {
    if(isPlaying) {
      pauseAudio();
    } else {
      if(currentIndex === -1 && playlist.length > 0) {
        playTrack(0);
      } else {
        audio.play().catch(() => {});
        isPlaying = true;
        updatePlayPauseButton();
      }
    }
  }

  function pauseAudio() {
    audio.pause();
    isPlaying = false;
    updatePlayPauseButton();
  }

  // Update UI play/pause icon
  function updatePlayPauseButton() {
    playPauseBtn.textContent = isPlaying ? "‚è∏" : "‚ñ∂Ô∏è";
  }

  // Update cover art
  function updateCoverArt(url) {
    coverArt.src = url || defaultCoverArt;
    coverArt.alt = isPlaying && currentIndex !== -1 ? playlist[currentIndex].title : locale.noTrack;
  }

  // Update active playlist item highlight
  function updatePlaylistActive() {
    const items = playlistEl.querySelectorAll('.playlist-item');
    items.forEach(item => {
      item.classList.remove('active');
      if(parseInt(item.dataset.idx, 10) === currentIndex) {
        item.classList.add('active');
        // Scroll into view smoothly
        item.scrollIntoView({behavior: 'smooth', block: 'nearest'});
      }
    });
  }

  // Shuffle toggle
  function toggleShuffle() {
    shuffle = !shuffle;
    shuffleBtn.setAttribute('aria-pressed', shuffle);
    shuffleBtn.style.color = shuffle ? 'var(--primary-color)' : '';
  }

  // Repeat toggle
  function toggleRepeat() {
    repeat = !repeat;
    repeatBtn.setAttribute('aria-pressed', repeat);
    repeatBtn.style.color = repeat ? 'var(--primary-color)' : '';
  }

  // Play streaming URL
  function playStream() {
    const url = streamUrlInput.value.trim();
    if(!url) return;
    audio.src = url;
    audio.play().catch(() => {});
    isPlaying = true;
    currentIndex = -1;
    updatePlayPauseButton();
    updateCoverArt(defaultCoverArt);
    updatePlaylistActive();
  }

  // Export playlist to JSON file
  function exportPlaylist() {
    if(playlist.length === 0) {
      alert(locale.noSongsInPlaylist);
      return;
    }
    const json = JSON.stringify(playlist, null, 2);
    const blob = new Blob([json], {type: "application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = "playlist.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Import playlist from JSON file
  function importPlaylistFromFile(file) {
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const imported = JSON.parse(e.target.result);
        if(Array.isArray(imported)) {
          // Basic validation
          playlist = imported.filter(t => t.url);
          currentIndex = -1;
          isPlaying = false;
          audio.pause();
          audio.src = "";
          updateCoverArt(defaultCoverArt);
          renderPlaylist();
          updatePlayPauseButton();
        } else {
          alert(locale.importError);
        }
      } catch {
        alert(locale.importError);
      }
    };
    reader.readAsText(file);
  }

  // Drag & drop handlers for files
  function onDragOver(e) {
    e.preventDefault();
    container.classList.add('dragover');
  }
  function onDragLeave(e) {
    e.preventDefault();
    container.classList.remove('dragover');
  }
  function onDrop(e) {
    e.preventDefault();
    container.classList.remove('dragover');
    const files = Array.from(e.dataTransfer.files);
    const accepted = files.filter(f => isSupportedFileType(f.name));
    if(accepted.length === 0) {
      alert(locale.fileNotSupported);
      return;
    }
    // Add to playlist
    accepted.forEach(file => {
      const track = createTrackObject(file);
      playlist.push(track);
    });
    renderPlaylist();
  }

  // Keyboard shortcuts
  function onKeyDown(e) {
    if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

    switch(e.key.toLowerCase()) {
      case ' ':
        e.preventDefault();
        togglePlayPause();
        break;
      case 'arrowright':
        e.preventDefault();
        playNext();
        break;
      case 'arrowleft':
        e.preventDefault();
        playPrev();
        break;
      case 's':
        e.preventDefault();
        toggleShuffle();
        break;
      case 'r':
        e.preventDefault();
        toggleRepeat();
        break;
    }
  }

  // Visualizer setup
  function setupVisualizer() {
    try {
      audioCtx = new AudioContext();
      analyser = audioCtx.createAnalyser();
      source = audioCtx.createMediaElementSource(audio);
      source.connect(analyser);
      analyser.connect(audioCtx.destination);
      analyser.fftSize = 256;
      const bufferLength = analyser.frequencyBinCount;
      dataArray = new Uint8Array(bufferLength);

      const canvasCtx = visualizerCanvas.getContext('2d');
      const WIDTH = visualizerCanvas.width = visualizerCanvas.clientWidth;
      const HEIGHT = visualizerCanvas.height = visualizerCanvas.clientHeight;

      function draw() {
        animationId = requestAnimationFrame(draw);
        analyser.getByteFrequencyData(dataArray);

        canvasCtx.fillStyle = '#181818';
        canvasCtx.fillRect(0, 0, WIDTH, HEIGHT);

        const barWidth = (WIDTH / bufferLength) * 1.5;
        let x = 0;
        for(let i = 0; i < bufferLength; i++) {
          const barHeight = dataArray[i] / 2;
          // Get the current primary color from the CSS variable
          const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
          canvasCtx.fillStyle = primaryColor;
          canvasCtx.fillRect(x, HEIGHT - barHeight, barWidth, barHeight);
          x += barWidth + 1;
        }
      }

      draw();
    } catch(e) {
      console.warn("Visualizer not supported", e);
    }
  }

  // Resize visualizer canvas on window resize
  window.addEventListener('resize', () => {
    if(visualizerCanvas) {
      visualizerCanvas.width = visualizerCanvas.clientWidth;
      visualizerCanvas.height = visualizerCanvas.clientHeight;
    }
  });

  // Initialize
  function init() {
    // Event listeners
    playPauseBtn.addEventListener('click', togglePlayPause);
    prevBtn.addEventListener('click', playPrev);
    nextBtn.addEventListener('click', playNext);
    shuffleBtn.addEventListener('click', toggleShuffle);
    repeatBtn.addEventListener('click', toggleRepeat);
    searchInput.addEventListener('input', renderPlaylist);
    playStreamBtn.addEventListener('click', playStream);
    exportPlaylistBtn.addEventListener('click', exportPlaylist);
    importPlaylistBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', e => {
      importPlaylistFromFile(e.target.files[0]);
      importFileInput.value = '';
    });

    container.addEventListener('dragover', onDragOver);
    container.addEventListener('dragleave', onDragLeave);
    container.addEventListener('drop', onDrop);

    window.addEventListener('keydown', onKeyDown);

    audio.addEventListener('ended', playNext);
    audio.addEventListener('play', () => {
      isPlaying = true;
      updatePlayPauseButton();
      // Resume audio context if suspended
      if(audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
    });
    audio.addEventListener('pause', () => {
      isPlaying = false;
      updatePlayPauseButton();
    });

    langSelect.addEventListener('change', () => {
      const val = langSelect.value;
      locale = locales[val] || locales.en;
      updateLocaleTexts();
      renderPlaylist();
    });

    themeColorPicker.addEventListener('input', (e) => {
      document.documentElement.style.setProperty('--primary-color', e.target.value);
      updatePlaylistActive();
    });

    updateCoverArt(defaultCoverArt);
    renderPlaylist();
    setupVisualizer();

    // Service Worker Registration
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered with scope:', registration.scope);
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      });
    }
  }

  init();

})();
</script>
</body>
</html>